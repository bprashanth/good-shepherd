# Development setup

The environment is initialized using a "init" container that writes directly to your host machine's filesystem.

## Iteration loop

### On a new machine (i.e. first run) 

Run the following from the project root:

```bash
./docker/init.sh

```

### On a reboot (i.e. post first run)

All init files already exist, just run 
```
docker compose -f docker/step0_docker-compose.yml up -d
```

### Verification 

If this succeedes, then 
* To apply code changes: `docker exec ... bench migrate`
```bash
docker exec -it -w /home/frappe/project/frappe-bench nursery_frappe bench --site nursery.localhost migrate
```
* To save UI changes to code: `docker exec ... bench export-fixtures`
```bash
docker exec -it -w /home/frappe/project/frappe-bench nursery_frappe bench --site nursery.localhost export-fixtures
```
* To test logic: `docker exec ... bench console`
```bash
# Check if a DocType is loaded and accessible
docker exec -it -w /home/frappe/project/frappe-bench nursery_frappe bench --site nursery.localhost console

```

```python
# Inside the console:
frappe.get_meta("Species") # Should return the metadata object for your DocType

```

#### What the init command does:

You _must_ run init at least once before you begin to code. Here's what it does: 

1. **Purges** any stale containers and volumes.
2. **Clears** the local `frappe-bench/` directory to ensure a clean landing zone.
3. **Mounts** your host project directory into the container.
4. **Runs `bench init**`, creating a Python virtual environment and the Frappe framework.
5. **Configures** MariaDB and Redis links.
6. **Scaffolds** the custom app: `nursery`.

---

## Starting to code 

Before coding, verify that the app has successfully synchronized with your host.

### File System Check (Host Side)

Ensure these paths exist in your local repository:

* `frappe-bench/apps/nursery/`: The heart of your custom logic.
* `frappe-bench/sites/nursery.localhost/`: Your site data and config.

### Registry Check

Verify that the app is registered in the site manifest:

```bash
cat frappe-bench/sites/apps.txt
# Expected: 
# frappe
# nursery

```

### Connectivity Check

Visit **[http://nursery.localhost:8000](https://www.google.com/search?q=http://nursery.localhost:8000)**.

* **User:** `Administrator`
* **Pass:** `admin`

---

## The Code: Project Layout

Eg engineering goal is to modify DocTypes and logic that live within the `apps/nursery` directory.

### Repository Structure

```text
.
 docker/               # Docker Compose and entrypoint scripts
 frappe-bench/         # [GIT IGNORED] parts of this are ignored (see below)
   apps/
     frappe/           # [GIT IGNORED] Core framework
     nursery/          # <--- APP CODE LIVES HERE
   sites/
 .gitignore            
...

```
Checked into git
* docker/ (Everything: compose files, entrypoints, init.sh).
* frappe-bench/apps/nursery/ (entire custom app logic).
* frappe-bench/sites/common_site_config.json (Database and Redis links).
* frappe-bench/sites/apps.txt (The list that tells Frappe to load the app).

NOT checked in (generated by `init.sh`)
* frappe-bench/env/
* frappe-bench/apps/frappe/
* frappe-bench/sites/assets/

### DocType Locations

Each DocType is a directory under `frappe-bench/apps/nursery/nursery/nursery/doctype/<doctype_name>/`:

* **`.json`**: Schema, fields, and permissions.
* **`.py`**: Controller logic, hooks (Python).
* **`.js`**: Client-side UI logic.

For the POC, focus on JSON definitions with minimal Python logic.

DocTypes to implement (POC):
- Species
- Nursery
- Section
- Bed
- Collection
- Batch
- Batch Allocation (child table on Batch)
- Nursery Event

### Fixtures location 

Recommended approach: **fixtures** for stable defaults.

- `nursery/fixtures/` should include JSON for:
  - Stages (collection, sowing, germination, growing, planting)
  - Category lists (item_type, condition, seed_site, bed_type)

Alternate approach: **patches** if defaults need logic.

### Smoke tests 

* Create a Species record.
* Create a Collection record.
* Create a Batch record and Allocation record.
* Add a Nursery Event (germination) with absolute count.

**Indicators (Script Reports)**:
- Germination rate (quantity vs total seeds) by species/batch/date.
- Earliest / latest germination date by species/batch.
- Germination spread (latest - earliest).
- Stock by stage (derived from events + batch totals).
- Height distribution (min/max) by species/batch/date.
- Exit totals by species/batch/date.

Run Script Reports filtered by species/batch/date and confirm expected totals.

---

## Typical Journey (Collection → Exit)

1) **Collection**
   - Field team creates a Collection record with GPS/species/etc.

2) **Batch Creation (Sowing)**
   - Nursery team creates a Batch (sowing implied).
   - Add Collections in the Batch “Collections” table with quantities.

3) **Germination**
   - Create a Nursery Event with `event_type = germination` and quantity.

4) **Growing**
   - Create a Nursery Event with `event_type = growth` and min/max height.

5) **Transplant (Germination → Growing)**
   - Create a Nursery Event with `event_type = transplant` and from/to section+bed.

6) **Exit (Growing → Out of Nursery)**
   - Create a Nursery Event with `event_type = exit` and quantity (no destination).
   - Plantation is downstream of Exit and out of scope for the POC.

## User Actions (POC)

**Add a new Species**
- Enter Scientific Name; Species Code auto-generates (editable).
- Add optional Local Names with language/dialect.

**Add a new Collection**
- Record field details, GPS, and delivery date.

**Create a new Batch**
- Select Species, enter totals, optionally date_sown.
- Add one or more Collections and quantities.

**Add an Event**
- Germination: absolute count only.
- Move: from/to section+bed + quantity.
- Transplant: from/to section+bed + quantity (germination → growing).
- Growth: min/max height only.
- Failure: notes (optional).
- Exit: from section+bed + quantity (growing → out of nursery).
